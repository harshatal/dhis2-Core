<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery -->
    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/angular.min.js"></script>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <!--<script type="text/javascript" src="../javascripts/jQuery/jquery.min.js"></script>-->
    <!--<link type="text/css" rel="stylesheet" href="../css/widgets.css">-->
    <!--<link type="text/css" rel="stylesheet" href="../css/login.css">-->
    <!--<link type="text/css" rel="stylesheet" href="../../api/files/style/external" />-->
    <script src="//dhis2-cdn.org/v221/ext/ext-all.js"></script>



</head>


<body>
</body>
<script type="text/javascript">
    var orgid;
    $(document)
            .ready(function() {
                debugger
                Ext.Ajax.request({
                    url: "../../" + "dhis-web-commons-security/login.action",
                    method: "POST",
                    params: {j_username: "admin", j_password: "district"},

                });

                $.getJSON("../../api/organisationUnitGroups/mH15ENlpG4v.json?fields=organisationUnits[id,name,code]", function (data) {
                    $.each(data.organisationUnits, function (index, item) {
                        $('#drop1').append(
                                $('<option></option>').val(item.id).html(item.name).text(item.name)
                        );
//
                    });




                });

                $("#drop1").change(function () {


                    orgid = $(this).find("option:selected").val();
                    //   alert(orgid);

                    jQuery('#sel').html('');
                });

            });


    function submitdata(){
        //alert(orgid);
        debugger
        var orgname=document.getElementById("hospital").value;
        var password=document.getElementById("password").value;
        var username=document.getElementById("username").value;

        var header = {

            "Authorization": "Basic " + btoa( "admin" + ':' + "district" )

        };
        var orgunit = {
            name:"OU-"+orgname,
            code : orgname,
            parent:{
                id : orgid
            },
            openingDate:"2016-01-01",
            shortName: "OU-"+orgname,
            phoneNumber : "98566"
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            header : header,
            url: '../../api/organisationUnits/',
            data: JSON.stringify(orgunit),
            success: function(response){
                var orgid=response.response.lastImported;
                alert(orgid);
                assignprogram(orgid);
                createUser(orgid);

            },
            error: function(response){

            }
        });

        var user = {
            firstName:username,
            surname : username,
            email:"sss",
            userCredentials: {
                "username": username,
                "password": password,
                "userRoles": [ {
                    "id": "yrB6vc5Ip3r"
                } ]
            },

            organisationUnits:[{

                id:orgid
            }]
        }



        function  assignprogram(orgid)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                header : header,
                url: '../../api/programs/tzR46QRZ6FJ/organisationUnits/'+orgid,
                success: function(response){

                },
                error: function(response){

                }
            });

        }

        function  createUser(orgid)
        {
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                header : header,
                url: '../../api/users/',
                data: JSON.stringify(user),
                success: function(response){
                    debugger
                },
                error: function(response){
                    debugger

                }
            });

        }



    }
</script>

<div style="text-align: center">
    <select id="drop1"  >
        <option value="all" disabled selected hidden>Please Select Parent</option>
    </select>
    <form action="">
        User Name<br>
        <input type="text"  id="username">
        <br>   Password<br>
        <input type="password"id="password">
        <br>   Hospital Name<br>
        <input type="text"  id="hospital">
        <br>
        <br>
        <input type="submit" value="Submit" id="submit" onclick="submitdata()">
    </form>
</div>
</html>